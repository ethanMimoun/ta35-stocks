<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×ª×Ÿ:×ª"×35</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8fafc; color: #1e293b; direction: rtl; }

    /* HEADER */
    .header { background: #0f172a; color: white; padding: 24px; border-bottom: 4px solid #1e293b; }
    .header-inner { max-width: 1200px; margin: 0 auto; }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; flex-wrap: wrap; gap: 16px; }
    .header-title h1 { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
    .header-title p { color: #94a3b8; font-size: 15px; }
    .header-stats { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .stat-box { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 8px 16px; text-align: center; }
    .stat-box .label { font-size: 11px; color: #94a3b8; }
    .stat-box .value { font-size: 24px; font-weight: 800; }
    .stat-box .value.green { color: #22c55e; }
    .stat-box .value.red { color: #ef4444; }
    .stat-box .value.gold { color: #f59e0b; }
    .refresh-btn { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 10px 14px; cursor: pointer; color: #94a3b8; font-size: 18px; transition: all 0.2s; }
    .refresh-btn:hover { background: #334155; color: white; }
    .refresh-btn.spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .status-bar { font-size: 12px; margin-top: 8px; }
    .status-ok { color: #22c55e; }
    .status-loading { color: #fbbf24; }
    .status-error { color: #ef4444; }

    /* SEARCH */
    .search-wrap { position: relative; margin-top: 16px; }
    .search-wrap input { width: 100%; padding: 14px 48px 14px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 16px; font-family: inherit; direction: rtl; background: white; }
    .search-wrap input:focus { outline: none; border-color: #475569; box-shadow: 0 0 0 3px rgba(71,85,105,0.15); }
    .search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 18px; pointer-events: none; }

    /* MAIN */
    .main { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

    /* ALERT BANNER */
    .alert-banner { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); color: white; padding: 20px 24px; margin-bottom: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 4px 12px rgba(0,0,0,0.15); flex-wrap: wrap; gap: 12px; }
    .alert-banner-content { flex: 1; }
    .alert-banner h3 { font-size: 16px; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; }
    .alert-banner p { font-size: 13px; color: #cbd5e1; }
    .alert-banner-btn { background: #22c55e; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 14px; transition: all 0.2s; white-space: nowrap; }
    .alert-banner-btn:hover { background: #16a34a; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(34,197,94,0.3); }
    .alert-banner-btn.enabled { background: #64748b; }
    .alert-banner-btn.enabled:hover { background: #475569; }

    /* SORT BUTTONS */
    .sort-bar { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .sort-bar span { font-size: 13px; font-weight: 600; color: #475569; margin-left: 4px; }
    .sort-btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f1f5f9; color: #475569; cursor: pointer; font-size: 13px; font-weight: 500; font-family: inherit; transition: all 0.15s; }
    .sort-btn:hover { background: #e2e8f0; }
    .sort-btn.active { background: #0f172a; color: white; border-color: #0f172a; }
    .sort-btn.active.green { background: #16a34a; border-color: #16a34a; }
    .sort-btn.active.red { background: #dc2626; border-color: #dc2626; }
    .sort-btn.active.star { background: #f59e0b; border-color: #f59e0b; }

    /* SECTOR FILTER */
    .filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-bar span { font-size: 13px; font-weight: 600; color: #475569; }
    .filter-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #475569; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .filter-btn:hover { background: #f1f5f9; }
    .filter-btn.active { background: #0f172a; color: white; border-color: #0f172a; }

    /* RESULTS COUNT */
    .results-count { font-size: 13px; color: #64748b; margin-bottom: 12px; }

    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

    /* CARD */
    .card { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; position: relative; }
    .card:hover { border-color: #0f172a; box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-1px); }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .card-name { flex: 1; }
    .card-badge { display: inline-block; font-size: 11px; font-weight: 700; background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; margin-bottom: 4px; }
    .card-hname { font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 2px; }
    .card-price-wrap { text-align: left; }
    .card-price { font-size: 22px; font-weight: 800; color: #0f172a; }
    .card-change { font-size: 13px; font-weight: 600; }
    .card-change.up { color: #16a34a; }
    .card-change.down { color: #dc2626; }
    .card-sector { font-size: 11px; background: #f1f5f9; color: #475569; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 12px; }
    .card-stats { display: grid; grid-template-columns: 1fr 1fr auto; gap: 8px; border-top: 1px solid #e2e8f0; padding-top: 12px; align-items: center; }
    .card-stat-label { font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
    .card-stat-value { font-size: 14px; font-weight: 600; color: #0f172a; }

    /* FAVORITE BUTTON */
    .fav-btn { background: white; border: 2px solid #e2e8f0; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px; transition: all 0.2s; }
    .fav-btn:hover { transform: scale(1.15); border-color: #f59e0b; }
    .fav-btn.active { background: #fef3c7; border-color: #f59e0b; }
    @keyframes pulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    /* MODAL OVERLAY */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 100; align-items: center; justify-content: center; padding: 16px; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 8px; max-width: 680px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 24px 64px rgba(0,0,0,0.25); }
    .modal-header { background: #0f172a; color: white; padding: 24px; border-radius: 8px 8px 0 0; position: sticky; top: 0; }
    .modal-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .modal-close { background: none; border: none; color: #94a3b8; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; }
    .modal-close:hover { color: white; }
    .modal-badge { font-size: 12px; background: #1e293b; padding: 3px 10px; border-radius: 4px; display: inline-block; margin-bottom: 6px; }
    .modal-title { font-size: 26px; font-weight: 800; margin-bottom: 2px; }
    .modal-subtitle { color: #94a3b8; font-size: 14px; }
    .modal-price { font-size: 40px; font-weight: 800; }
    .modal-change { font-size: 18px; font-weight: 600; }
    .modal-change.up { color: #4ade80; }
    .modal-change.down { color: #f87171; }
    .modal-body { padding: 24px; }
    .modal-section { margin-bottom: 24px; }
    .modal-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #0f172a; }
    .modal-desc { color: #475569; line-height: 1.6; font-size: 14px; }
    .modal-sector-tag { display: inline-block; background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; }
    .modal-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; background: #f8fafc; border-radius: 8px; padding: 16px; border: 1px solid #e2e8f0; }
    .modal-stat { background: white; border-radius: 6px; padding: 12px; border: 1px solid #e2e8f0; }
    .modal-stat-label { font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
    .modal-stat-value { font-size: 18px; font-weight: 800; color: #0f172a; }
    .modal-stat-value.green { color: #16a34a; }
    .modal-stat-value.red { color: #dc2626; }
    .modal-links { display: flex; flex-direction: column; gap: 8px; }
    .modal-link { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; text-decoration: none; color: #0f172a; transition: all 0.15s; font-weight: 500; font-size: 14px; }
    .modal-link:hover { border-color: #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .modal-link-icon { font-size: 18px; }
    .modal-note { background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; padding: 14px; font-size: 13px; color: #475569; }

    /* EMPTY STATE */
    .empty { text-align: center; padding: 60px 20px; grid-column: 1 / -1; }
    .empty-icon { font-size: 56px; margin-bottom: 16px; }
    .empty h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .empty p { color: #64748b; }

    /* FOOTER NOTE */
    .footer-note { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-top: 32px; }
    .footer-note h3 { font-weight: 700; margin-bottom: 10px; }
    .footer-note p { font-size: 13px; color: #475569; margin-bottom: 4px; }

    @media (max-width: 600px) {
      .header-top { flex-direction: column; }
      .modal-stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
      .alert-banner { flex-direction: column; align-items: stretch; }
      .alert-banner-btn { width: 100%; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-top">
      <div class="header-title">
        <h1>ğŸ“ˆ ×‘×•×¨×¡×” ×™×©×¨××œ - ××“×“ ×ª×´× 35</h1>
        <p>××™×“×¢ × ×’×™×© ×•×‘×¨×•×¨ ×¢×œ ×”×—×‘×¨×•×ª ×”××•×‘×™×œ×•×ª ×‘×‘×•×¨×¡×”</p>
      </div>
      <div>
        <div class="header-stats">
          <div class="stat-box">
            <div class="label">×¢×•×œ×™×</div>
            <div class="value green" id="stat-up">-</div>
          </div>
          <div class="stat-box">
            <div class="label">×™×•×¨×“×™×</div>
            <div class="value red" id="stat-down">-</div>
          </div>
          <div class="stat-box">
            <div class="label">××•×¢×“×¤×™×</div>
            <div class="value gold" id="stat-favs">0</div>
          </div>
          <button class="refresh-btn" id="refresh-btn" onclick="fetchData()" title="×¨×¢× ×Ÿ × ×ª×•× ×™×">âŸ³</button>
        </div>
        <div class="status-bar" id="status-bar">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </div>
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©× ×—×‘×¨×”, ×¡×™××•×œ ××• ×¢× ×£..." oninput="render()">
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- ALERT BANNER -->
  <div class="alert-banner" id="alert-banner">
    <div class="alert-banner-content">
      <h3>ğŸ”” ×”×ª×¨××•×ª ×—×›××•×ª</h3>
      <p>×§×‘×œ ×”×ª×¨××” ×›×©×× ×™×” ××•×¢×“×¤×ª â­ ×¢×•×œ×” ××• ×™×•×¨×“×ª ××¢×œ 5%</p>
    </div>
    <button class="alert-banner-btn" id="alert-btn" onclick="toggleAlerts()">
      <span id="alert-btn-text">×”×¤×¢×œ ×”×ª×¨××•×ª</span>
    </button>
  </div>

  <!-- SORT BAR -->
  <div class="sort-bar">
    <span>××™×•×Ÿ:</span>
    <button class="sort-btn active" id="sort-default" onclick="setSort('default')">×‘×¨×™×¨×ª ××—×“×œ</button>
    <button class="sort-btn" id="sort-favorites" onclick="setSort('favorites')">â­ ×”××•×¢×“×¤×™× ×©×œ×™</button>
    <button class="sort-btn" id="sort-gainers" onclick="setSort('gainers')">ğŸ“ˆ ×¢×•×œ×™× ×‘×™×•×ª×¨</button>
    <button class="sort-btn" id="sort-losers" onclick="setSort('losers')">ğŸ“‰ ×™×•×¨×“×™× ×‘×™×•×ª×¨</button>
    <button class="sort-btn" id="sort-marketcap" onclick="setSort('marketcap')">ğŸ’° ×©×•×•×™ ×©×•×§ ×’×‘×•×”</button>
    <button class="sort-btn" id="sort-volume" onclick="setSort('volume')">ğŸ“Š × ×¤×— ××¡×—×¨ ×’×‘×•×”</button>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar" id="filter-bar">
    <span>×¡×™× ×•×Ÿ ×œ×¤×™ ×¢× ×£:</span>
  </div>

  <!-- RESULTS COUNT -->
  <div class="results-count" id="results-count"></div>

  <!-- CARDS GRID -->
  <div class="grid" id="cards-grid"></div>

  <!-- FOOTER -->
  <div class="footer-note">
    <h3>ğŸ“Œ ××™×“×¢ ×—×©×•×‘</h3>
    <p>â€¢ ×”××¤×œ×™×§×¦×™×” ××ª×—×‘×¨×ª ×™×©×™×¨×•×ª ×œ-Google Sheets ×©×œ×š ×•××ª×¨×¢× × ×ª ×›×œ 2 ×“×§×•×ª ××•×˜×•××˜×™×ª</p>
    <p>â€¢ ×”××•×¢×“×¤×™× ×•×”×”×ª×¨××•×ª × ×©××¨×™× ×‘×˜×œ×¤×•×Ÿ ×©×œ×š ×‘-localStorage</p>
    <p>â€¢ ×œ× ×ª×•× ×™× ××¢×•×“×›× ×™× ×‘×–××Ÿ ×××ª, ×™×© ×œ×”×™×›× ×¡ ×œ××ª×¨ ×”×‘×•×¨×¡×” ×”×¨×©××™</p>
    <p>â€¢ ×”×¤×œ×˜×¤×•×¨××” ××™× ×” ××¡×¤×§×ª ×™×™×¢×•×¥ ×”×©×§×¢×•×ª ××• ×”××œ×¦×•×ª</p>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-box"></div>
</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2LehOqxokrErTsaaKs3AdUMpbQ6sD6syzz9WoFYQf_npXQcQe_760VD7ODqaRYD3jwcAgIfPhh70k/pub?gid=0&single=true&output=csv';
const REFRESH_INTERVAL = 2 * 60 * 1000;

const SECTOR_MAP = {
  'OPCE':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','ORA':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','ICL':'×›×™××™×” ×•×—×•××¨×™×',
  'ESLT':'×ª×¢×©×™×™×” ×‘×™×˜×—×•× ×™×ª','AMOT':'× ×“×œ"×Ÿ','ENLT':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª',
  'BEZQ':'×ª×§×©×•×¨×ª','BIG':'×§××¢×•× ××•×ª','DSCT':'×‘× ×§××•×ª','LUMI':'×‘× ×§××•×ª',
  'POLI':'×‘× ×§××•×ª','MZTF':'×‘× ×§××•×ª','FIBI':'×‘× ×§××•×ª',
  'DLEKG':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','DIMRI':'× ×“×œ"×Ÿ','PHOE':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×',
  'HARL':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','TSEM':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'TEVA':'×ª×¨×•×¤×•×ª ×•×‘×™×•×˜×›× ×•×œ×•×’×™×”','CLIS':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','MVNE':'× ×“×œ"×Ÿ',
  'MGDL':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','MLSR':'× ×“×œ"×Ÿ','MMHD':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×',
  'NVPT':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','NVMI':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'NWMD':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','NICE':'×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”','NXSN':'×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”',
  'AZRG':'× ×“×œ"×Ÿ','FTAL':'× ×“×œ"×Ÿ','CAMT':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'SAE':'×§××¢×•× ××•×ª','STRS':'××–×•×Ÿ ×•××©×§××•×ª','SPEN':'×‘× ×™×™×” ×•×ª×©×ª×™×•×ª'
};

const WEBSITE_MAP = {
  'ESLT':'https://www.elbitsystems.com','ICL':'https://www.icl-group.com',
  'ORA':'https://www.ormat.com','BEZQ':'https://www.bezeq.co.il',
  'DSCT':'https://www.discountbank.co.il','LUMI':'https://www.leumi.co.il',
  'POLI':'https://www.bankhapoalim.co.il','MZTF':'https://www.mizrahi-tefahot.co.il',
  'FIBI':'https://www.fibi.co.il','PHOE':'https://www.fnx.co.il',
  'HARL':'https://www.harel-group.co.il','TSEM':'https://www.towersemi.com',
  'TEVA':'https://www.tevapharm.com','CLIS':'https://www.clalbit.co.il',
  'MGDL':'https://www.migdal.co.il','MLSR':'https://www.melisron.co.il',
  'MMHD':'https://www.menora.co.il','NVMI':'https://www.novami.com',
  'NWMD':'https://www.newmed-energy.com','NICE':'https://www.nice.com',
  'AZRG':'https://www.azrieli.com','AMOT':'https://www.amot.co.il',
  'ENLT':'https://www.enlightenergy.co.il','DLEKG':'https://www.delek-group.com',
  'DIMRI':'https://www.dimri.co.il','BIG':'https://www.big.co.il',
  'SAE':'https://www.shufersal.co.il','STRS':'https://www.strauss-group.com',
  'SPEN':'https://www.shikun-binui.com','CAMT':'https://www.camtek.com'
};

let companies = [];
let currentSort = 'default';
let currentSector = '';
let secondsLeft = 120;
let countdownTimer = null;

// ××¢×¨×›×ª ××•×¢×“×¤×™× ×•×”×ª×¨××•×ª
let favorites = JSON.parse(localStorage.getItem('ta35-favorites') || '[]');
let alertsEnabled = localStorage.getItem('ta35-alerts-enabled') === 'true';
let lastPrices = JSON.parse(localStorage.getItem('ta35-last-prices') || '{}');

// ×¢×“×›×•×Ÿ ×›×¤×ª×•×¨ ×”×”×ª×¨××•×ª ×‘×˜×¢×™× ×”
document.addEventListener('DOMContentLoaded', () => {
  updateAlertButton();
});

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += line[i]; }
  }
  result.push(current.trim());
  return result;
}

function cleanNumber(s) {
  if (!s) return 0;
  return parseFloat(String(s).replace(/[â‚ª,\s]/g, '')) || 0;
}

function parseSheetData(csvText) {
  const lines = csvText.split('\n').filter(l => l.trim());
  const result = [];
  for (let i = 2; i < lines.length; i++) {
    const parts = parseCSVLine(lines[i]);
    if (parts.length < 7 || !parts[2].includes('TLV:')) continue;
    const symbol = parts[2].replace('TLV:', '').trim();
    const price = cleanNumber(parts[3]);
    const changePercent = cleanNumber(parts[4].replace('%', ''));
    if (!price) continue;
    result.push({
      id: symbol,
      name: parts[1].trim(),
      sector: SECTOR_MAP[symbol] || '×›×œ×œ×™',
      price,
      change: parseFloat((price * changePercent / 100).toFixed(2)),
      changePercent,
      volume: Math.round(cleanNumber(parts[6])),
      marketCap: parseFloat((cleanNumber(parts[5]) / 1000000000).toFixed(2)),
      yearHigh: parseFloat((price * 1.3).toFixed(2)),
      yearLow:  parseFloat((price * 0.7).toFixed(2)),
      website: WEBSITE_MAP[symbol] || 'https://www.tase.co.il'
    });
  }
  return result;
}

function formatVolume(v) {
  if (v >= 1000000) return (v/1000000).toFixed(1) + 'M';
  if (v >= 1000)    return (v/1000).toFixed(0) + 'K';
  return v;
}

function setStatus(type, msg) {
  const el = document.getElementById('status-bar');
  el.className = 'status-bar status-' + type;
  el.textContent = msg;
}

function startCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
  secondsLeft = 120;
  countdownTimer = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) { secondsLeft = 120; }
    const m = Math.floor(secondsLeft / 60);
    const s = String(secondsLeft % 60).padStart(2, '0');
    const lastUpdate = document.getElementById('last-update-time');
    const el = document.getElementById('status-bar');
    if (el && lastUpdate) {
      el.textContent = `âœ… ×¢×•×“×›×Ÿ ×‘-${lastUpdate.dataset.time} Â· ×¢×“×›×•×Ÿ ×‘×¢×•×“ ${m}:${s}`;
    }
  }, 1000);
}

// ×‘×“×™×§×ª ×”×ª×¨××•×ª - ×¨×§ ×œ×× ×™×•×ª ××•×¢×“×¤×•×ª ×¢× ×©×™× ×•×™ ××¢×œ 5%
function checkAlerts(newCompanies) {
  if (!alertsEnabled || favorites.length === 0) return;
  
  newCompanies.forEach(company => {
    // ×‘×“×•×§ ×× ×”×× ×™×” ×‘××•×¢×“×¤×™×
    if (!favorites.includes(company.id)) return;
    
    const lastPrice = lastPrices[company.id];
    if (!lastPrice) {
      lastPrices[company.id] = company.price;
      return;
    }
    
    const priceChange = ((company.price - lastPrice) / lastPrice) * 100;
    
    // ×”×ª×¨××” ×¨×§ ×× ×”×©×™× ×•×™ ××¢×œ 5% (×—×™×•×‘×™ ××• ×©×œ×™×œ×™)
    if (Math.abs(priceChange) >= 5) {
      const direction = priceChange > 0 ? '×¢×œ×ª×”' : '×™×¨×“×”';
      const emoji = priceChange > 0 ? 'ğŸ“ˆ' : 'ğŸ“‰';
      
      if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(`${emoji} ${company.name}`, {
          body: `×”×× ×™×” ${direction} ×‘-${Math.abs(priceChange).toFixed(2)}%!\n××—×™×¨ × ×•×›×—×™: â‚ª${company.price.toFixed(2)}`,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">ğŸ“ˆ</text></svg>',
          badge: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">â­</text></svg>'
        });
      }
      
      // ×¢×“×›×Ÿ ××—×™×¨ ××—×¨×•×Ÿ ××—×¨×™ ×”×ª×¨××”
      lastPrices[company.id] = company.price;
      localStorage.setItem('ta35-last-prices', JSON.stringify(lastPrices));
    }
  });
}

async function fetchData() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  setStatus('loading', 'â³ ××ª×¢×“×›×Ÿ...');

  const PROXIES = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://cors-anywhere.herokuapp.com/${url}`,
    url => url
  ];

  for (const proxy of PROXIES) {
    try {
      const res = await fetch(proxy(SHEET_URL + '&t=' + Date.now()));
      if (!res.ok) continue;
      const text = await res.text();
      const parsed = parseSheetData(text);
      if (parsed.length > 0) {
        // ×‘×“×•×§ ×”×ª×¨××•×ª ×œ×¤× ×™ ×¢×“×›×•×Ÿ
        checkAlerts(parsed);
        
        companies = parsed;
        const now = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        let timeEl = document.getElementById('last-update-time');
        if (!timeEl) {
          timeEl = document.createElement('span');
          timeEl.id = 'last-update-time';
          timeEl.style.display = 'none';
          document.body.appendChild(timeEl);
        }
        timeEl.dataset.time = now;
        setStatus('ok', `âœ… ×¢×•×“×›×Ÿ ×‘-${now} Â· ×¢×“×›×•×Ÿ ×‘×¢×•×“ 2:00`);
        startCountdown();
        render();
        btn.classList.remove('spinning');
        return;
      }
    } catch(e) { continue; }
  }

  setStatus('error', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×” - ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜');
  btn.classList.remove('spinning');
}

// ×¤×•× ×§×¦×™×•×ª ××•×¢×“×¤×™×
function toggleFavorite(id, event) {
  event.stopPropagation();
  const index = favorites.indexOf(id);
  if (index > -1) {
    favorites.splice(index, 1);
    delete lastPrices[id]; // ××—×§ ×’× ××”××—×™×¨×™× ×”××—×¨×•× ×™×
  } else {
    favorites.push(id);
    const company = companies.find(c => c.id === id);
    if (company) {
      lastPrices[id] = company.price; // ×©××•×¨ ××—×™×¨ ×”×ª×—×œ×ª×™
    }
  }
  localStorage.setItem('ta35-favorites', JSON.stringify(favorites));
  localStorage.setItem('ta35-last-prices', JSON.stringify(lastPrices));
  render();
}

function isFavorite(id) {
  return favorites.includes(id);
}

// ×¤×•× ×§×¦×™×•×ª ×”×ª×¨××•×ª
async function toggleAlerts() {
  if (!alertsEnabled) {
    // ×‘×§×© ×”×¨×©××”
    if ('Notification' in window) {
      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        alertsEnabled = true;
        localStorage.setItem('ta35-alerts-enabled', 'true');
        
        // ×©××•×¨ ××—×™×¨×™× × ×•×›×—×™×™× ×©×œ ××•×¢×“×¤×™×
        favorites.forEach(favId => {
          const company = companies.find(c => c.id === favId);
          if (company && !lastPrices[favId]) {
            lastPrices[favId] = company.price;
          }
        });
        localStorage.setItem('ta35-last-prices', JSON.stringify(lastPrices));
        
        // ×”×ª×¨××ª ×”×¦×œ×—×”
        new Notification('ğŸ”” ×”×ª×¨××•×ª ×”×•×¤×¢×œ×•!', {
          body: `×ª×§×‘×œ ×”×ª×¨××” ×›×©×× ×™×” ××•×¢×“×¤×ª ×ª×¢×œ×”/×ª×¨×“ ××¢×œ 5%`,
          icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">â­</text></svg>'
        });
      } else {
        alert('×œ× × ×™×ª×Ÿ ×œ×”×¤×¢×™×œ ×”×ª×¨××•×ª ×œ×œ× ×”×¨×©××” ××”×“×¤×“×¤×Ÿ');
        return;
      }
    } else {
      alert('×”×“×¤×“×¤×Ÿ ×©×œ×š ×œ× ×ª×•××š ×‘×”×ª×¨××•×ª');
      return;
    }
  } else {
    // ×›×‘×” ×”×ª×¨××•×ª
    alertsEnabled = false;
    localStorage.setItem('ta35-alerts-enabled', 'false');
  }
  
  updateAlertButton();
}

function updateAlertButton() {
  const btn = document.getElementById('alert-btn');
  const btnText = document.getElementById('alert-btn-text');
  
  if (alertsEnabled) {
    btn.classList.add('enabled');
    btnText.textContent = 'ğŸ”• ×›×‘×” ×”×ª×¨××•×ª';
  } else {
    btn.classList.remove('enabled');
    btnText.textContent = 'ğŸ”” ×”×¤×¢×œ ×”×ª×¨××•×ª';
  }
}

function setSort(type) {
  currentSort = type;
  document.querySelectorAll('.sort-btn').forEach(b => {
    b.classList.remove('active','green','red','star');
  });
  const btn = document.getElementById('sort-' + type);
  btn.classList.add('active');
  if (type === 'gainers') btn.classList.add('green');
  if (type === 'losers')  btn.classList.add('red');
  if (type === 'favorites') btn.classList.add('star');
  render();
}

function setSector(sector) {
  currentSector = sector;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.filter-btn').forEach(b => {
    if (b.dataset.sector === sector) b.classList.add('active');
  });
  render();
}

function renderFilters() {
  const sectors = [...new Set(companies.map(c => c.sector))].sort();
  const bar = document.getElementById('filter-bar');
  bar.innerHTML = '<span>×¡×™× ×•×Ÿ ×œ×¤×™ ×¢× ×£:</span>';

  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn' + (currentSector === '' ? ' active' : '');
  allBtn.dataset.sector = '';
  allBtn.textContent = `×”×›×œ (${companies.length})`;
  allBtn.onclick = () => setSector('');
  bar.appendChild(allBtn);

  sectors.forEach(s => {
    const count = companies.filter(c => c.sector === s).length;
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (currentSector === s ? ' active' : '');
    btn.dataset.sector = s;
    btn.textContent = `${s} (${count})`;
    btn.onclick = () => setSector(s);
    bar.appendChild(btn);
  });
}

function getFiltered() {
  const q = document.getElementById('search-input').value.trim().toLowerCase();
  let list = companies.filter(c => {
    const matchSearch = !q || c.name.includes(q) || c.id.toLowerCase().includes(q) || c.sector.includes(q);
    const matchSector = !currentSector || c.sector === currentSector;
    const matchFavorites = currentSort !== 'favorites' || isFavorite(c.id);
    return matchSearch && matchSector && matchFavorites;
  });
  if (currentSort === 'gainers')   list = [...list].sort((a,b) => b.changePercent - a.changePercent);
  if (currentSort === 'losers')    list = [...list].sort((a,b) => a.changePercent - b.changePercent);
  if (currentSort === 'marketcap') list = [...list].sort((a,b) => b.marketCap - a.marketCap);
  if (currentSort === 'volume')    list = [...list].sort((a,b) => b.volume - a.volume);
  return list;
}

function render() {
  renderFilters();
  const filtered = getFiltered();

  // ×¢×“×›×•×Ÿ ×¡×˜×˜×™×¡×˜×™×§×•×ª
  document.getElementById('stat-up').textContent   = companies.filter(c => c.changePercent > 0).length;
  document.getElementById('stat-down').textContent = companies.filter(c => c.changePercent < 0).length;
  document.getElementById('stat-favs').textContent = favorites.length;

  const resultText = currentSort === 'favorites' && filtered.length === 0
    ? '××™×Ÿ ×× ×™×•×ª ××•×¢×“×¤×•×ª - ×œ×—×¥ ×¢×œ â­ ×›×“×™ ×œ×”×•×¡×™×£'
    : filtered.length === companies.length
      ? `××¦×™×’ ${filtered.length} ×—×‘×¨×•×ª`
      : `× ××¦××• ${filtered.length} ×ª×•×¦××•×ª`;
  
  document.getElementById('results-count').textContent = resultText;

  const grid = document.getElementById('cards-grid');

  if (filtered.length === 0) {
    const emptyMsg = currentSort === 'favorites'
      ? '<div class="empty"><div class="empty-icon">â­</div><h3>××™×Ÿ ×× ×™×•×ª ××•×¢×“×¤×•×ª</h3><p>×œ×—×¥ ×¢×œ ×”×›×•×›×‘ â­ ×œ×™×“ ×× ×™×” ×›×“×™ ×œ×”×•×¡×™×£ ×œ××•×¢×“×¤×™×</p></div>'
      : '<div class="empty"><div class="empty-icon">ğŸ”</div><h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3><p>× ×¡×” ×œ×—×¤×© ××©×”×• ××—×¨ ××• ×œ×©× ×•×ª ××ª ×”×¡×™× ×•×Ÿ</p></div>';
    grid.innerHTML = emptyMsg;
    return;
  }

  grid.innerHTML = filtered.map(c => {
    const up = c.changePercent >= 0;
    const arrow = up ? 'â–²' : 'â–¼';
    const cls = up ? 'up' : 'down';
    const sign = up ? '+' : '';
    const fav = isFavorite(c.id);
    const favIcon = fav ? 'â­' : 'â˜†';
    const favClass = fav ? 'active' : '';
    
    return `
      <div class="card" onclick="openModal('${c.id}')">
        <div class="card-top">
          <div class="card-name">
            <span class="card-badge">${c.id}</span>
            <div class="card-hname">${c.name}</div>
          </div>
          <div class="card-price-wrap">
            <div class="card-price">â‚ª${c.price.toFixed(2)}</div>
            <div class="card-change ${cls}">${arrow} ${sign}${c.change.toFixed(2)} (${sign}${c.changePercent.toFixed(2)}%)</div>
          </div>
        </div>
        <span class="card-sector">${c.sector}</span>
        <div class="card-stats">
          <div>
            <div class="card-stat-label">×©×•×•×™ ×©×•×§</div>
            <div class="card-stat-value">â‚ª${c.marketCap}B</div>
          </div>
          <div>
            <div class="card-stat-label">× ×¤×— 24H</div>
            <div class="card-stat-value">${formatVolume(c.volume)}</div>
          </div>
          <div class="fav-btn ${favClass}" onclick="toggleFavorite('${c.id}', event)" title="${fav ? '×”×¡×¨ ×××•×¢×“×¤×™×' : '×”×•×¡×£ ×œ××•×¢×“×¤×™×'}">${favIcon}</div>
        </div>
      </div>`;
  }).join('');
}

function openModal(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  const up = c.changePercent >= 0;
  const sign = up ? '+' : '';
  const cls = up ? 'up' : 'down';
  
  document.getElementById('modal-box').innerHTML = `
    <div class="modal-header">
      <div class="modal-header-top">
        <div>
          <span class="modal-badge">${c.id}</span>
          <div class="modal-title">${c.name}</div>
          <div class="modal-subtitle">××“×“ ×ª"× 35</div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="display:flex;align-items:baseline;gap:12px;margin-top:8px">
        <span class="modal-price">â‚ª${c.price.toFixed(2)}</span>
        <span class="modal-change ${cls}">${sign}${c.change.toFixed(2)} (${sign}${c.changePercent.toFixed(2)}%)</span>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <h3>ğŸ“‹ ×ª×™××•×¨ ×”×—×‘×¨×”</h3>
        <p class="modal-desc">×—×‘×¨×” ×¦×™×‘×•×¨×™×ª ×”× ×¡×—×¨×ª ×‘×‘×•×¨×¡×ª ×ª×œ ××‘×™×‘ ×‘××¡×’×¨×ª ××“×“ ×ª"× 35.</p>
        <span class="modal-sector-tag">${c.sector}</span>
      </div>
      <div class="modal-section">
        <h3>ğŸ“Š × ×ª×•× ×™× ×¢×™×§×¨×™×™×</h3>
        <div class="modal-stats-grid">
          <div class="modal-stat">
            <div class="modal-stat-label">×©×•×•×™ ×©×•×§</div>
            <div class="modal-stat-value">â‚ª${c.marketCap}B</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">× ×¤×— 24H</div>
            <div class="modal-stat-value">${formatVolume(c.volume)}</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">×©×™× ×©× ×ª×™ (××•××“×Ÿ)</div>
            <div class="modal-stat-value green">â‚ª${c.yearHigh.toFixed(2)}</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">×©×¤×œ ×©× ×ª×™ (××•××“×Ÿ)</div>
            <div class="modal-stat-value red">â‚ª${c.yearLow.toFixed(2)}</div>
          </div>
        </div>
      </div>
      <div class="modal-section">
        <h3>ğŸ”— ×§×™×©×•×¨×™× ×•××©××‘×™×</h3>
        <div class="modal-links">
          <a href="${c.website}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸŒ</span> ××ª×¨ ×”×—×‘×¨×”
          </a>
          <a href="https://www.tase.co.il/he/market_data/security/${c.id}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸ“ˆ</span> × ×ª×•× ×™× ×‘×‘×•×¨×¡×” ×œ× ×™×™×¨×•×ª ×¢×¨×š
          </a>
          <a href="https://maya.tase.co.il/company/${c.id}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸ“„</span> ×“×•×—×•×ª ×›×¡×¤×™×™× ×‘×××™×”
          </a>
        </div>
      </div>
      <div class="modal-note">
        <strong>×©×™× ×œ×‘:</strong> ×”× ×ª×•× ×™× ××ª×¢×“×›× ×™× ××”-Google Sheets ×©×œ×š ×›×œ 2 ×“×§×•×ª. ×œ× ×ª×•× ×™× ××“×•×™×§×™× ×‘×–××Ÿ ×××ª, ×¢×‘×•×¨ ×œ××ª×¨ ×”×‘×•×¨×¡×”.
      </div>
    </div>`;
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('modal-overlay')) {
    document.getElementById('modal-overlay').classList.remove('open');
  }
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ×˜×¢×™× ×” ×¨××©×•× ×™×ª + ×¨×™×¢× ×•×Ÿ ××•×˜×•××˜×™
fetchData();
setInterval(fetchData, REFRESH_INTERVAL);
</script>
</body>
</html>
