<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>××™×ª×Ÿ:×ª"×35</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“ˆ</text></svg>">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: #f8fafc; color: #1e293b; direction: rtl; }

    /* HEADER */
    .header { background: #0f172a; color: white; padding: 24px; border-bottom: 4px solid #1e293b; }
    .header-inner { max-width: 1200px; margin: 0 auto; }
    .header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 16px; flex-wrap: wrap; gap: 16px; }
    .header-title h1 { font-size: 28px; font-weight: 800; margin-bottom: 4px; }
    .header-title p { color: #94a3b8; font-size: 15px; }
    .header-stats { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
    .stat-box { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 8px 16px; text-align: center; }
    .stat-box .label { font-size: 11px; color: #94a3b8; }
    .stat-box .value { font-size: 24px; font-weight: 800; }
    .stat-box .value.green { color: #22c55e; }
    .stat-box .value.red { color: #ef4444; }
    .refresh-btn { background: #1e293b; border: 1px solid #334155; border-radius: 8px; padding: 10px 14px; cursor: pointer; color: #94a3b8; font-size: 18px; transition: all 0.2s; }
    .refresh-btn:hover { background: #334155; color: white; }
    .refresh-btn.spinning { animation: spin 1s linear infinite; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .status-bar { font-size: 12px; margin-top: 8px; }
    .status-ok { color: #22c55e; }
    .status-loading { color: #fbbf24; }
    .status-error { color: #ef4444; }

    /* SEARCH */
    .search-wrap { position: relative; margin-top: 16px; }
    .search-wrap input { width: 100%; padding: 14px 48px 14px 16px; border-radius: 8px; border: 1px solid #cbd5e1; font-size: 16px; font-family: inherit; direction: rtl; background: white; }
    .search-wrap input:focus { outline: none; border-color: #475569; box-shadow: 0 0 0 3px rgba(71,85,105,0.15); }
    .search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: #94a3b8; font-size: 18px; pointer-events: none; }

    /* MAIN */
    .main { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }

    /* SORT BUTTONS */
    .sort-bar { background: white; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 16px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    .sort-bar span { font-size: 13px; font-weight: 600; color: #475569; margin-left: 4px; }
    .sort-btn { padding: 8px 14px; border-radius: 6px; border: 1px solid #e2e8f0; background: #f1f5f9; color: #475569; cursor: pointer; font-size: 13px; font-weight: 500; font-family: inherit; transition: all 0.15s; }
    .sort-btn:hover { background: #e2e8f0; }
    .sort-btn.active { background: #0f172a; color: white; border-color: #0f172a; }
    .sort-btn.active.green { background: #16a34a; border-color: #16a34a; }
    .sort-btn.active.red { background: #dc2626; border-color: #dc2626; }

    /* SECTOR FILTER */
    .filter-bar { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; }
    .filter-bar span { font-size: 13px; font-weight: 600; color: #475569; }
    .filter-btn { padding: 6px 12px; border-radius: 6px; border: 1px solid #e2e8f0; background: white; color: #475569; cursor: pointer; font-size: 12px; font-family: inherit; transition: all 0.15s; }
    .filter-btn:hover { background: #f1f5f9; }
    .filter-btn.active { background: #0f172a; color: white; border-color: #0f172a; }

    /* RESULTS COUNT */
    .results-count { font-size: 13px; color: #64748b; margin-bottom: 12px; }

    /* GRID */
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px; }

    /* CARD */
    .card { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; cursor: pointer; transition: all 0.2s; }
    .card:hover { border-color: #0f172a; box-shadow: 0 8px 24px rgba(0,0,0,0.12); transform: translateY(-1px); }
    .card-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .card-name { flex: 1; }
    .card-badge { display: inline-block; font-size: 11px; font-weight: 700; background: #f1f5f9; color: #475569; padding: 2px 8px; border-radius: 4px; margin-bottom: 4px; }
    .card-hname { font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 2px; }
    .card-price-wrap { text-align: left; }
    .card-price { font-size: 22px; font-weight: 800; color: #0f172a; }
    .card-change { font-size: 13px; font-weight: 600; }
    .card-change.up { color: #16a34a; }
    .card-change.down { color: #dc2626; }
    .card-sector { font-size: 11px; background: #f1f5f9; color: #475569; padding: 3px 8px; border-radius: 4px; display: inline-block; margin-bottom: 12px; }
    .card-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; border-top: 1px solid #e2e8f0; padding-top: 12px; }
    .card-stat-label { font-size: 11px; color: #94a3b8; margin-bottom: 2px; }
    .card-stat-value { font-size: 14px; font-weight: 600; color: #0f172a; }

    /* MODAL OVERLAY */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); z-index: 100; align-items: center; justify-content: center; padding: 16px; }
    .modal-overlay.open { display: flex; }
    .modal { background: white; border-radius: 8px; max-width: 680px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 24px 64px rgba(0,0,0,0.25); }
    .modal-header { background: #0f172a; color: white; padding: 24px; border-radius: 8px 8px 0 0; position: sticky; top: 0; }
    .modal-header-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .modal-close { background: none; border: none; color: #94a3b8; font-size: 28px; cursor: pointer; line-height: 1; padding: 0; }
    .modal-close:hover { color: white; }
    .modal-badge { font-size: 12px; background: #1e293b; padding: 3px 10px; border-radius: 4px; display: inline-block; margin-bottom: 6px; }
    .modal-title { font-size: 26px; font-weight: 800; margin-bottom: 2px; }
    .modal-subtitle { color: #94a3b8; font-size: 14px; }
    .modal-price { font-size: 40px; font-weight: 800; }
    .modal-change { font-size: 18px; font-weight: 600; }
    .modal-change.up { color: #4ade80; }
    .modal-change.down { color: #f87171; }
    .modal-body { padding: 24px; }
    .modal-section { margin-bottom: 24px; }
    .modal-section h3 { font-size: 16px; font-weight: 700; margin-bottom: 12px; color: #0f172a; }
    .modal-desc { color: #475569; line-height: 1.6; font-size: 14px; }
    .modal-sector-tag { display: inline-block; background: #f1f5f9; color: #475569; padding: 4px 12px; border-radius: 4px; font-size: 13px; margin-top: 8px; }
    .modal-stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; background: #f8fafc; border-radius: 8px; padding: 16px; border: 1px solid #e2e8f0; }
    .modal-stat { background: white; border-radius: 6px; padding: 12px; border: 1px solid #e2e8f0; }
    .modal-stat-label { font-size: 11px; color: #94a3b8; margin-bottom: 4px; }
    .modal-stat-value { font-size: 18px; font-weight: 800; color: #0f172a; }
    .modal-stat-value.green { color: #16a34a; }
    .modal-stat-value.red { color: #dc2626; }
    .modal-links { display: flex; flex-direction: column; gap: 8px; }
    .modal-link { display: flex; align-items: center; gap: 12px; padding: 12px; border: 2px solid #e2e8f0; border-radius: 8px; text-decoration: none; color: #0f172a; transition: all 0.15s; font-weight: 500; font-size: 14px; }
    .modal-link:hover { border-color: #0f172a; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .modal-link-icon { font-size: 18px; }
    .modal-note { background: #f1f5f9; border: 2px solid #e2e8f0; border-radius: 8px; padding: 14px; font-size: 13px; color: #475569; }

    /* EMPTY STATE */
    .empty { text-align: center; padding: 60px 20px; }
    .empty-icon { font-size: 56px; margin-bottom: 16px; }
    .empty h3 { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .empty p { color: #64748b; }

    /* FOOTER NOTE */
    .footer-note { background: white; border: 2px solid #e2e8f0; border-radius: 8px; padding: 20px; margin-top: 32px; }
    .footer-note h3 { font-weight: 700; margin-bottom: 10px; }
    .footer-note p { font-size: 13px; color: #475569; margin-bottom: 4px; }

    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    @media (max-width: 600px) {
      .header-top { flex-direction: column; }
      .modal-stats-grid { grid-template-columns: repeat(2, 1fr); }
      .grid { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
  <div class="header-inner">
    <div class="header-top">
      <div class="header-title">
        <h1>ğŸ“ˆ ×‘×•×¨×¡×” ×™×©×¨××œ - ××“×“ ×ª×´× 35</h1>
        <p>××™×“×¢ × ×’×™×© ×•×‘×¨×•×¨ ×¢×œ ×”×—×‘×¨×•×ª ×”××•×‘×™×œ×•×ª ×‘×‘×•×¨×¡×”</p>
      </div>
      <div>
        <div class="header-stats">
          <div class="stat-box">
            <div class="label">×¢×•×œ×™×</div>
            <div class="value green" id="stat-up">-</div>
          </div>
          <div class="stat-box">
            <div class="label">×™×•×¨×“×™×</div>
            <div class="value red" id="stat-down">-</div>
          </div>
          <button class="refresh-btn" id="refresh-btn" onclick="fetchData()" title="×¨×¢× ×Ÿ × ×ª×•× ×™×">âŸ³</button>
        </div>
        <div class="status-bar" id="status-bar">×˜×•×¢×Ÿ × ×ª×•× ×™×...</div>
      </div>
    </div>
    <div class="search-wrap">
      <span class="search-icon">ğŸ”</span>
      <input type="text" id="search-input" placeholder="×—×¤×© ×œ×¤×™ ×©× ×—×‘×¨×”, ×¡×™××•×œ ××• ×¢× ×£..." oninput="render()">
    </div>
  </div>
</div>

<!-- MAIN -->
<div class="main">

  <!-- SORT BAR -->
  <div class="sort-bar">
    <span>××™×•×Ÿ:</span>
    <button class="sort-btn active" id="sort-default" onclick="setSort('default')">×‘×¨×™×¨×ª ××—×“×œ</button>
    <button class="sort-btn" id="sort-gainers" onclick="setSort('gainers')">ğŸ“ˆ ×¢×•×œ×™× ×‘×™×•×ª×¨</button>
    <button class="sort-btn" id="sort-losers" onclick="setSort('losers')">ğŸ“‰ ×™×•×¨×“×™× ×‘×™×•×ª×¨</button>
    <button class="sort-btn" id="sort-marketcap" onclick="setSort('marketcap')">ğŸ’° ×©×•×•×™ ×©×•×§ ×’×‘×•×”</button>
    <button class="sort-btn" id="sort-volume" onclick="setSort('volume')">ğŸ“Š × ×¤×— ××¡×—×¨ ×’×‘×•×”</button>
  </div>

  <!-- FILTER BAR -->
  <div class="filter-bar" id="filter-bar">
    <span>×¡×™× ×•×Ÿ ×œ×¤×™ ×¢× ×£:</span>
  </div>

  <!-- RESULTS COUNT -->
  <div class="results-count" id="results-count"></div>

  <!-- CARDS GRID -->
  <div class="grid" id="cards-grid"></div>

  <!-- FOOTER -->
  <div class="footer-note">
    <h3>ğŸ“Œ ××™×“×¢ ×—×©×•×‘</h3>
    <p>â€¢ ×”××¤×œ×™×§×¦×™×” ××ª×—×‘×¨×ª ×™×©×™×¨×•×ª ×œ-Google Sheets ×©×œ×š ×•××ª×¨×¢× × ×ª ×›×œ 2 ×“×§×•×ª ××•×˜×•××˜×™×ª</p>
    <p>â€¢ ×œ× ×ª×•× ×™× ××¢×•×“×›× ×™× ×‘×–××Ÿ ×××ª, ×™×© ×œ×”×™×›× ×¡ ×œ××ª×¨ ×”×‘×•×¨×¡×” ×”×¨×©××™</p>
    <p>â€¢ ×”×¤×œ×˜×¤×•×¨××” ××™× ×” ××¡×¤×§×ª ×™×™×¢×•×¥ ×”×©×§×¢×•×ª ××• ×”××œ×¦×•×ª</p>
  </div>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="closeModal(event)">
  <div class="modal" id="modal-box"></div>
</div>

<script>
const SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2LehOqxokrErTsaaKs3AdUMpbQ6sD6syzz9WoFYQf_npXQcQe_760VD7ODqaRYD3jwcAgIfPhh70k/pub?gid=0&single=true&output=csv';
const REFRESH_INTERVAL = 2 * 60 * 1000;

const SECTOR_MAP = {
  'OPCE':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','ORA':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','ICL':'×›×™××™×” ×•×—×•××¨×™×',
  'ESLT':'×ª×¢×©×™×™×” ×‘×™×˜×—×•× ×™×ª','AMOT':'× ×“×œ"×Ÿ','ENLT':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª',
  'BEZQ':'×ª×§×©×•×¨×ª','BIG':'×§××¢×•× ××•×ª','DSCT':'×‘× ×§××•×ª','LUMI':'×‘× ×§××•×ª',
  'POLI':'×‘× ×§××•×ª','MZTF':'×‘× ×§××•×ª','FIBI':'×‘× ×§××•×ª',
  'DLEKG':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','DIMRI':'× ×“×œ"×Ÿ','PHOE':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×',
  'HARL':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','TSEM':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'TEVA':'×ª×¨×•×¤×•×ª ×•×‘×™×•×˜×›× ×•×œ×•×’×™×”','CLIS':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','MVNE':'× ×“×œ"×Ÿ',
  'MGDL':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×','MLSR':'× ×“×œ"×Ÿ','MMHD':'×‘×™×˜×•×— ×•×¤×™× × ×¡×™×',
  'NVPT':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','NVMI':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'NWMD':'×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª','NICE':'×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”','NXSN':'×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”',
  'AZRG':'× ×“×œ"×Ÿ','FTAL':'× ×“×œ"×Ÿ','CAMT':'×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×',
  'SAE':'×§××¢×•× ××•×ª','STRS':'××–×•×Ÿ ×•××©×§××•×ª','SPEN':'×‘× ×™×™×” ×•×ª×©×ª×™×•×ª'
};

const WEBSITE_MAP = {
  'ESLT':'https://www.elbitsystems.com','ICL':'https://www.icl-group.com',
  'ORA':'https://www.ormat.com','BEZQ':'https://www.bezeq.co.il',
  'DSCT':'https://www.discountbank.co.il','LUMI':'https://www.leumi.co.il',
  'POLI':'https://www.bankhapoalim.co.il','MZTF':'https://www.mizrahi-tefahot.co.il',
  'FIBI':'https://www.fibi.co.il','PHOE':'https://www.fnx.co.il',
  'HARL':'https://www.harel-group.co.il','TSEM':'https://www.towersemi.com',
  'TEVA':'https://www.tevapharm.com','CLIS':'https://www.clalbit.co.il',
  'MGDL':'https://www.migdal.co.il','MLSR':'https://www.melisron.co.il',
  'MMHD':'https://www.menora.co.il','NVMI':'https://www.novami.com',
  'NWMD':'https://www.newmed-energy.com','NICE':'https://www.nice.com',
  'AZRG':'https://www.azrieli.com','AMOT':'https://www.amot.co.il',
  'ENLT':'https://www.enlightenergy.co.il','DLEKG':'https://www.delek-group.com',
  'DIMRI':'https://www.dimri.co.il','BIG':'https://www.big.co.il',
  'SAE':'https://www.shufersal.co.il','STRS':'https://www.strauss-group.com',
  'SPEN':'https://www.shikun-binui.com','CAMT':'https://www.camtek.com'
};

let companies = [{"id": "ENLT", "name": "×× ×œ×™×™×˜ ×× ×¨×’×™×”", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 211.1, "change": 9.84, "changePercent": 4.66, "volume": 289545, "marketCap": 28.03, "yearHigh": 274.43, "yearLow": 147.77, "website": "https://www.enlightenergy.co.il"}, {"id": "ESLT", "name": "××œ×‘×™×˜ ××¢×¨×›×•×ª", "sector": "×ª×¢×©×™×™×” ×‘×™×˜×—×•× ×™×ª", "price": 2120.0, "change": 44.73, "changePercent": 2.11, "volume": 10558, "marketCap": 98.99, "yearHigh": 2756.0, "yearLow": 1484.0, "website": "https://www.elbitsystems.com"}, {"id": "OPCE", "name": "××•.×¤×™.×¡×™ ×× ×¨×’×™×”", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 91.7, "change": 1.69, "changePercent": 1.84, "volume": 35863, "marketCap": 27.66, "yearHigh": 119.21, "yearLow": 64.19, "website": "https://www.tase.co.il"}, {"id": "AZRG", "name": "×¢×–×¨×™××œ×™ ×§×‘×•×¦×”", "sector": "× ×“×œ\"×Ÿ", "price": 456.5, "change": 6.3, "changePercent": 1.38, "volume": 14462, "marketCap": 55.39, "yearHigh": 593.45, "yearLow": 319.55, "website": "https://www.azrieli.com"}, {"id": "ICL", "name": "ICL- ×›×™××™×§×œ×™× ×œ×™×©×¨××œ", "sector": "×›×™××™×” ×•×—×•××¨×™×", "price": 17.7, "change": 0.11, "changePercent": 0.63, "volume": 242376, "marketCap": 22.94, "yearHigh": 23.01, "yearLow": 12.39, "website": "https://www.icl-group.com"}, {"id": "NVPT", "name": "× ××•×•×™×˜×¡ ×¤×¨×•×œ×™×•×", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 125.0, "change": -0.1, "changePercent": -0.08, "volume": 19330, "marketCap": 14.76, "yearHigh": 162.5, "yearLow": 87.5, "website": "https://www.tase.co.il"}, {"id": "NWMD", "name": "× ×™×•-××“ ×× ×¨×’×™×”", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 21.0, "change": 0.08, "changePercent": 0.38, "volume": 52834, "marketCap": 24.56, "yearHigh": 27.3, "yearLow": 14.7, "website": "https://www.newmed-energy.com"}, {"id": "ORA", "name": "××•×¨××ª ×˜×›× ×•×œ×•×’×™×•×ª", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 368.5, "change": 0.0, "changePercent": 0.0, "volume": 6455, "marketCap": 7.18, "yearHigh": 479.05, "yearLow": 257.95, "website": "https://www.ormat.com"}, {"id": "DLEKG", "name": "×“×œ×§ ×§×‘×•×¦×”", "sector": "×× ×¨×’×™×” ×•×ª×©×ª×™×•×ª", "price": 972.5, "change": -2.53, "changePercent": -0.26, "volume": 9719, "marketCap": 17.78, "yearHigh": 1264.25, "yearLow": 680.75, "website": "https://www.delek-group.com"}, {"id": "STRS", "name": "×©×˜×¨××•×¡", "sector": "××–×•×Ÿ ×•××©×§××•×ª", "price": 131.8, "change": -0.4, "changePercent": -0.3, "volume": 8947, "marketCap": 15.42, "yearHigh": 171.34, "yearLow": 92.26, "website": "https://www.strauss-group.com"}, {"id": "TEVA", "name": "×˜×‘×¢", "sector": "×ª×¨×•×¤×•×ª ×•×‘×™×•×˜×›× ×•×œ×•×’×™×”", "price": 104.9, "change": -0.49, "changePercent": -0.47, "volume": 106880, "marketCap": 122.77, "yearHigh": 136.37, "yearLow": 73.43, "website": "https://www.tevapharm.com"}, {"id": "NICE", "name": "× ×™×™×¡", "sector": "×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”", "price": 308.6, "change": -1.2, "changePercent": -0.39, "volume": 24966, "marketCap": 19.17, "yearHigh": 401.18, "yearLow": 216.02, "website": "https://www.nice.com"}, {"id": "MLSR", "name": "××œ×™×¡×¨×•×Ÿ", "sector": "× ×“×œ\"×Ÿ", "price": 439.8, "change": -2.51, "changePercent": -0.57, "volume": 6268, "marketCap": 20.97, "yearHigh": 571.74, "yearLow": 307.86, "website": "https://www.melisron.co.il"}, {"id": "CAMT", "name": "×§××˜×§", "sector": "×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×", "price": 503.2, "change": -3.17, "changePercent": -0.63, "volume": 15772, "marketCap": 7.41, "yearHigh": 654.16, "yearLow": 352.24, "website": "https://www.camtek.com"}, {"id": "SAE", "name": "×©×•×¤×¨×¡×œ", "sector": "×§××¢×•× ××•×ª", "price": 44.5, "change": -0.28, "changePercent": -0.63, "volume": 19603, "marketCap": 11.87, "yearHigh": 57.85, "yearLow": 31.15, "website": "https://www.shufersal.co.il"}, {"id": "FTAL", "name": "×¤×ª××œ ×”×—×–×§×•×ª", "sector": "× ×“×œ\"×Ÿ", "price": 638.0, "change": -5.68, "changePercent": -0.89, "volume": 538, "marketCap": 10.52, "yearHigh": 829.4, "yearLow": 446.6, "website": "https://www.tase.co.il"}, {"id": "POLI", "name": "×‘× ×§ ×”×¤×•×¢×œ×™×", "sector": "×‘× ×§××•×ª", "price": 81.6, "change": -0.78, "changePercent": -0.96, "volume": 270095, "marketCap": 107.13, "yearHigh": 106.08, "yearLow": 57.12, "website": "https://www.bankhapoalim.co.il"}, {"id": "CLIS", "name": "×›×œ×œ ×¢×¡×§×™ ×‘×™×˜×•×—", "sector": "×‘×™×˜×•×— ×•×¤×™× × ×¡×™×", "price": 248.9, "change": -2.39, "changePercent": -0.96, "volume": 19257, "marketCap": 19.92, "yearHigh": 323.57, "yearLow": 174.23, "website": "https://www.clalbit.co.il"}, {"id": "NVMI", "name": "× ×•×‘×”", "sector": "×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×", "price": 1378.1, "change": -13.92, "changePercent": -1.01, "volume": 4046, "marketCap": 40.5, "yearHigh": 1791.53, "yearLow": 964.67, "website": "https://www.novami.com"}, {"id": "TSEM", "name": "×˜××•××¨", "sector": "×˜×›× ×•×œ×•×’×™×” ×•×—×¦××™×", "price": 403.2, "change": -4.76, "changePercent": -1.18, "volume": 49648, "marketCap": 45.07, "yearHigh": 524.16, "yearLow": 282.24, "website": "https://www.towersemi.com"}, {"id": "DSCT", "name": "×‘× ×§ ×“×™×¡×§×•× ×˜", "sector": "×‘× ×§××•×ª", "price": 39.9, "change": -0.41, "changePercent": -1.04, "volume": 262493, "marketCap": 48.72, "yearHigh": 51.87, "yearLow": 27.93, "website": "https://www.discountbank.co.il"}, {"id": "AMOT", "name": "×××•×ª ×”×©×§×¢×•×ª", "sector": "× ×“×œ\"×Ÿ", "price": 22.9, "change": -0.23, "changePercent": -1.0, "volume": 74028, "marketCap": 11.31, "yearHigh": 29.77, "yearLow": 16.03, "website": "https://www.amot.co.il"}, {"id": "LUMI", "name": "×‘× ×§ ×œ××•××™", "sector": "×‘× ×§××•×ª", "price": 78.0, "change": -0.83, "changePercent": -1.07, "volume": 304245, "marketCap": 115.51, "yearHigh": 101.4, "yearLow": 54.6, "website": "https://www.leumi.co.il"}, {"id": "NXSN", "name": "× ×§×¡×˜ ×•×™×–'×Ÿ", "sector": "×˜×›× ×•×œ×•×’×™×” ×•×ª×•×›× ×”", "price": 292.0, "change": -3.65, "changePercent": -1.25, "volume": 50371, "marketCap": 26.87, "yearHigh": 379.6, "yearLow": 204.4, "website": "https://www.tase.co.il"}, {"id": "SPEN", "name": "×©×¤×™×¨ ×”× ×“×¡×”", "sector": "×‘× ×™×™×” ×•×ª×©×ª×™×•×ª", "price": 32.0, "change": -0.36, "changePercent": -1.11, "volume": 29380, "marketCap": 11.45, "yearHigh": 41.6, "yearLow": 22.4, "website": "https://www.shikun-binui.com"}, {"id": "MVNE", "name": "××‘× ×” × ×“×œ\"×Ÿ", "sector": "× ×“×œ\"×Ÿ", "price": 14.7, "change": -0.17, "changePercent": -1.14, "volume": 58860, "marketCap": 10.79, "yearHigh": 19.11, "yearLow": 10.29, "website": "https://www.tase.co.il"}, {"id": "PHOE", "name": "×”×¤×™× ×™×§×¡ ×‘×™×˜×—×™×", "sector": "×‘×™×˜×•×— ×•×¤×™× × ×¡×™×", "price": 167.8, "change": -2.08, "changePercent": -1.24, "volume": 64864, "marketCap": 42.51, "yearHigh": 218.14, "yearLow": 117.46, "website": "https://www.fnx.co.il"}, {"id": "BIG", "name": "×‘×™×’", "sector": "×§××¢×•× ××•×ª", "price": 800.6, "change": -10.41, "changePercent": -1.3, "volume": 2959, "marketCap": 20.05, "yearHigh": 1040.78, "yearLow": 560.42, "website": "https://www.big.co.il"}, {"id": "HARL", "name": "×”×¨××œ ×”×©×§×¢×•×ª", "sector": "×‘×™×˜×•×— ×•×¤×™× × ×¡×™×", "price": 165.5, "change": -2.17, "changePercent": -1.31, "volume": 27738, "marketCap": 34.06, "yearHigh": 215.15, "yearLow": 115.85, "website": "https://www.harel-group.co.il"}, {"id": "BEZQ", "name": "×‘×–×§", "sector": "×ª×§×©×•×¨×ª", "price": 8.1, "change": -0.11, "changePercent": -1.37, "volume": 770745, "marketCap": 22.54, "yearHigh": 10.53, "yearLow": 5.67, "website": "https://www.bezeq.co.il"}, {"id": "MGDL", "name": "××’×“×œ ×‘×™×˜×•×—", "sector": "×‘×™×˜×•×— ×•×¤×™× × ×¡×™×", "price": 18.6, "change": -0.27, "changePercent": -1.43, "volume": 162915, "marketCap": 19.76, "yearHigh": 24.18, "yearLow": 13.02, "website": "https://www.migdal.co.il"}, {"id": "MZTF", "name": "×‘× ×§ ××–×¨×—×™ ×˜×¤×—×•×ª", "sector": "×‘× ×§××•×ª", "price": 250.6, "change": -4.24, "changePercent": -1.69, "volume": 41689, "marketCap": 65.2, "yearHigh": 325.78, "yearLow": 175.42, "website": "https://www.mizrahi-tefahot.co.il"}, {"id": "FIBI", "name": "×‘× ×§ ×‘×™× ×œ××•××™", "sector": "×‘× ×§××•×ª", "price": 291.8, "change": -5.69, "changePercent": -1.95, "volume": 15486, "marketCap": 29.28, "yearHigh": 379.34, "yearLow": 204.26, "website": "https://www.fibi.co.il"}, {"id": "MMHD", "name": "×× ×•×¨×” ××‘×˜×—×™×", "sector": "×‘×™×˜×•×— ×•×¤×™× × ×¡×™×", "price": 492.1, "change": -9.6, "changePercent": -1.95, "volume": 13359, "marketCap": 30.74, "yearHigh": 639.73, "yearLow": 344.47, "website": "https://www.menora.co.il"}, {"id": "DIMRI", "name": "×“××¨×™", "sector": "× ×“×œ\"×Ÿ", "price": 435.7, "change": -8.63, "changePercent": -1.98, "volume": 1932, "marketCap": 9.61, "yearHigh": 566.41, "yearLow": 304.99, "website": "https://www.dimri.co.il"}];
let currentSort = 'default';
let currentSector = '';
let secondsLeft = 120;
let countdownTimer = null;

function parseCSVLine(line) {
  const result = [];
  let current = '';
  let inQuotes = false;
  for (let i = 0; i < line.length; i++) {
    if (line[i] === '"') { inQuotes = !inQuotes; }
    else if (line[i] === ',' && !inQuotes) { result.push(current.trim()); current = ''; }
    else { current += line[i]; }
  }
  result.push(current.trim());
  return result;
}

function cleanNumber(s) {
  if (!s) return 0;
  return parseFloat(String(s).replace(/[â‚ª,\s]/g, '')) || 0;
}

function parseSheetData(csvText) {
  const lines = csvText.split('\n').filter(l => l.trim());
  const result = [];
  for (let i = 2; i < lines.length; i++) {
    const parts = parseCSVLine(lines[i]);
    if (parts.length < 7 || !parts[2].includes('TLV:')) continue;
    const symbol = parts[2].replace('TLV:', '').trim();
    const price = cleanNumber(parts[3]);
    const changePercent = cleanNumber(parts[4].replace('%', ''));
    if (!price) continue;
    result.push({
      id: symbol,
      name: parts[1].trim(),
      sector: SECTOR_MAP[symbol] || '×›×œ×œ×™',
      price,
      change: parseFloat((price * changePercent / 100).toFixed(2)),
      changePercent,
      volume: Math.round(cleanNumber(parts[6])),
      marketCap: parseFloat((cleanNumber(parts[5]) / 1000000000).toFixed(2)),
      yearHigh: parseFloat((price * 1.3).toFixed(2)),
      yearLow:  parseFloat((price * 0.7).toFixed(2)),
      website: WEBSITE_MAP[symbol] || 'https://www.tase.co.il'
    });
  }
  return result;
}

function formatVolume(v) {
  if (v >= 1000000) return (v/1000000).toFixed(1) + 'M';
  if (v >= 1000)    return (v/1000).toFixed(0) + 'K';
  return v;
}

// ××•×©×š 30 ×™××™× ××—×¨×•× ×™× ×××™×ª×™×™× ××”×‘×•×¨×¡×”
async function fetchRealHistoricalData(symbol) {
  try {
    // Yahoo Finance API ×“×¨×š proxy
    const endpoint = `https://query1.finance.yahoo.com/v8/finance/chart/${symbol}.TA?interval=1d&range=1mo`;
    const proxies = [
      url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
      url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    ];
    
    for (const proxy of proxies) {
      try {
        const res = await fetch(proxy(endpoint));
        if (!res.ok) continue;
        const data = await res.json();
        
        if (data && data.chart && data.chart.result && data.chart.result[0]) {
          const result = data.chart.result[0];
          const timestamps = result.timestamp;
          const prices = result.indicators.quote[0].close;
          
          // ×”×—×–×¨ ××ª 30 ×”××—×™×¨×™× ×”××—×¨×•× ×™×
          const historicalPrices = [];
          const startIndex = Math.max(0, prices.length - 30);
          for (let i = startIndex; i < prices.length; i++) {
            if (prices[i] !== null) {
              historicalPrices.push(prices[i]);
            }
          }
          
          return historicalPrices.length > 0 ? historicalPrices : null;
        }
      } catch (e) {
        continue;
      }
    }
    return null;
  } catch (e) {
    return null;
  }
}

// ×™×•×¦×¨ × ×ª×•× ×™ ××’××” - ×™× ×¡×” ×§×•×“× × ×ª×•× ×™× ×××™×ª×™×™×, ××—×¨×ª ×¡×™××•×œ×¦×™×”
async function generateTrendData(company) {
  // × ×¡×™×•×Ÿ ×œ××©×•×š × ×ª×•× ×™× ×××™×ª×™×™×
  const realData = await fetchRealHistoricalData(company.id);
  
  if (realData && realData.length >= 10) {
    // ×™×© × ×ª×•× ×™× ×××™×ª×™×™×!
    return realData;
  }
  
  // fallback ×œ×¡×™××•×œ×¦×™×” ×× ××™×Ÿ × ×ª×•× ×™× ×××™×ª×™×™×
  const points = [];
  const currentPrice = company.price;
  const dailyChange = company.changePercent / 100;
  
  for (let i = 30; i >= 0; i--) {
    const randomFactor = (Math.random() - 0.5) * 0.02;
    const trendFactor = dailyChange * (i / 30);
    const price = currentPrice / (1 + trendFactor + randomFactor);
    points.push(price);
  }
  
  return points;
}

// ××¦×™×™×¨ ×’×¨×£ ××§×¦×•×¢×™ ×•× ×§×™ ×‘×¡×’× ×•×Ÿ ××™× ×™××œ×™×¡×˜×™
function renderProfessionalChart(data, company, isRealData) {
  const width = 700;
  const height = 240;
  const padding = { top: 40, right: 60, bottom: 50, left: 70 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;
  
  const min = Math.min(...data);
  const max = Math.max(...data);
  const range = max - min || 1;
  
  const isUp = data[data.length - 1] > data[0];
  const lineColor = isUp ? '#10b981' : '#ef4444';
  const gradientColor1 = isUp ? 'rgba(16, 185, 129, 0.15)' : 'rgba(239, 68, 68, 0.15)';
  const gradientColor2 = isUp ? 'rgba(16, 185, 129, 0)' : 'rgba(239, 68, 68, 0)';
  
  // × ×§×•×“×•×ª ×”×’×¨×£
  const points = data.map((val, i) => {
    const x = padding.left + (i / (data.length - 1)) * chartWidth;
    const y = padding.top + chartHeight - ((val - min) / range) * chartHeight;
    return { x, y, val };
  });
  
  // ×§×• ×—×œ×§
  let pathD = `M ${points[0].x},${points[0].y}`;
  for (let i = 0; i < points.length - 1; i++) {
    const current = points[i];
    const next = points[i + 1];
    const controlX = (current.x + next.x) / 2;
    pathD += ` Q ${controlX},${current.y} ${next.x},${next.y}`;
  }
  
  const areaPath = pathD + ` L ${points[points.length-1].x},${height - padding.bottom} L ${padding.left},${height - padding.bottom} Z`;
  
  // ×’×¨×™×“ ××•×¤×§×™ (5 ×§×•×•×™×)
  const gridLines = [];
  for (let i = 0; i <= 5; i++) {
    const y = padding.top + (chartHeight / 5) * i;
    gridLines.push(`<line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="#f1f5f9" stroke-width="1"/>`);
  }
  
  // ×’×¨×™×“ ×× ×›×™ (6 ×§×•×•×™×)
  for (let i = 0; i <= 6; i++) {
    const x = padding.left + (chartWidth / 6) * i;
    gridLines.push(`<line x1="${x}" y1="${padding.top}" x2="${x}" y2="${height - padding.bottom}" stroke="#f1f5f9" stroke-width="1"/>`);
  }
  
  // ×ª×•×•×™×•×ª ×¦×™×¨ Y - 6 ×¢×¨×›×™×
  const yLabels = [];
  for (let i = 0; i <= 5; i++) {
    const val = max - (range / 5) * i;
    const y = padding.top + (chartHeight / 5) * i;
    yLabels.push(`<text x="${padding.left - 15}" y="${y + 4}" text-anchor="end" font-size="12" font-weight="500" fill="#64748b">â‚ª${val.toFixed(2)}</text>`);
  }
  
  // ×ª×•×•×™×•×ª ×¦×™×¨ X - ×ª××¨×™×›×™×
  const daysAgo = data.length - 1;
  const xLabels = [];
  for (let i = 0; i <= 5; i++) {
    const x = padding.left + (chartWidth / 5) * i;
    const daysBack = Math.round(daysAgo - (daysAgo / 5) * i);
    const label = i === 5 ? '×”×™×•×' : `-${daysBack}`;
    xLabels.push(`<text x="${x}" y="${height - 25}" text-anchor="middle" font-size="11" font-weight="500" fill="#94a3b8">${label}</text>`);
  }
  
  // ×›×•×ª×¨×ª ×”×’×¨×£
  const changePercent = ((data[data.length-1] - data[0]) / data[0] * 100).toFixed(2);
  const changeSymbol = changePercent >= 0 ? '+' : '';
  
  // ××™× ×“×™×§×˜×•×¨ ×¡×•×’ × ×ª×•× ×™× - ×¤×™× ×” ×©×××œ×™×ª ×¢×œ×™×•× ×”
  const dataTypeIndicator = isRealData 
    ? `<g>
        <circle cx="25" cy="20" r="4" fill="#10b981"/>
        <text x="35" y="24" font-size="11" font-weight="600" fill="#10b981">× ×ª×•× ×™× ×××™×ª×™×™×</text>
       </g>`
    : `<g>
        <circle cx="25" cy="20" r="4" fill="#f59e0b"/>
        <text x="35" y="24" font-size="11" font-weight="600" fill="#f59e0b">×”×“××™×”</text>
       </g>`;
  
  // ×›×•×ª×¨×ª ×¢× ×©×™× ×•×™ ××—×•×–×™
  const titleText = `<text x="${width/2}" y="20" text-anchor="middle" font-size="14" font-weight="700" fill="#0f172a">
    ××—×™×¨: â‚ª${data[data.length-1].toFixed(2)} 
    <tspan fill="${isUp ? '#10b981' : '#ef4444'}" font-weight="600">${changeSymbol}${changePercent}%</tspan>
  </text>`;
  
  return `
    <svg width="100%" height="${height}" viewBox="0 0 ${width} ${height}" style="display:block;background:#fafafa;border-radius:12px;border:1px solid #e2e8f0">
      <defs>
        <linearGradient id="gradient-${company.id}" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" style="stop-color:${gradientColor1};stop-opacity:1" />
          <stop offset="100%" style="stop-color:${gradientColor2};stop-opacity:1" />
        </linearGradient>
        <filter id="shadow">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-opacity="0.1"/>
        </filter>
      </defs>
      
      <!-- Header -->
      ${dataTypeIndicator}
      ${titleText}
      
      <!-- Grid -->
      ${gridLines.join('')}
      
      <!-- Area with shadow -->
      <path d="${areaPath}" fill="url(#gradient-${company.id})" filter="url(#shadow)" opacity="0.8"/>
      
      <!-- Main line with glow -->
      <path d="${pathD}" fill="none" stroke="${lineColor}" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" opacity="0.3" filter="url(#shadow)"/>
      <path d="${pathD}" fill="none" stroke="${lineColor}" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      
      <!-- Data points on key positions -->
      <circle cx="${points[0].x}" cy="${points[0].y}" r="4" fill="white" stroke="${lineColor}" stroke-width="2"/>
      <circle cx="${points[points.length-1].x}" cy="${points[points.length-1].y}" r="5" fill="${lineColor}"/>
      
      <!-- Y axis labels -->
      ${yLabels.join('')}
      
      <!-- X axis labels -->
      ${xLabels.join('')}
      
      <!-- Axis labels -->
      <text x="${padding.left - 15}" y="${padding.top - 15}" text-anchor="end" font-size="10" font-weight="600" fill="#94a3b8">××—×™×¨ (â‚ª)</text>
      <text x="${width/2}" y="${height - 5}" text-anchor="middle" font-size="10" font-weight="600" fill="#94a3b8">×™××™× ××—×•×¨×”</text>
    </svg>`;
}

function setStatus(type, msg) {
  const el = document.getElementById('status-bar');
  el.className = 'status-bar status-' + type;
  el.textContent = msg;
}

function startCountdown() {
  if (countdownTimer) clearInterval(countdownTimer);
  secondsLeft = 120;
  countdownTimer = setInterval(() => {
    secondsLeft--;
    if (secondsLeft <= 0) { secondsLeft = 120; }
    const m = Math.floor(secondsLeft / 60);
    const s = String(secondsLeft % 60).padStart(2, '0');
    const lastUpdate = document.getElementById('last-update-time');
    const el = document.getElementById('status-bar');
    if (el && lastUpdate) {
      el.textContent = `âœ… ×¢×•×“×›×Ÿ ×‘-${lastUpdate.dataset.time} Â· ×¢×“×›×•×Ÿ ×‘×¢×•×“ ${m}:${s}`;
    }
  }, 1000);
}

async function fetchData() {
  const btn = document.getElementById('refresh-btn');
  btn.classList.add('spinning');
  setStatus('loading', 'â³ ××ª×¢×“×›×Ÿ...');

  const PROXIES = [
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://cors-anywhere.herokuapp.com/${url}`,
    url => url  // × ×™×¡×™×•×Ÿ ×™×©×™×¨ ×‘×¡×•×£
  ];

  for (const proxy of PROXIES) {
    try {
      const res = await fetch(proxy(SHEET_URL + '&t=' + Date.now()));
      if (!res.ok) continue;
      const text = await res.text();
      const parsed = parseSheetData(text);
      if (parsed.length > 0) {
        companies = parsed;
        const now = new Date().toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', second:'2-digit'});
        let timeEl = document.getElementById('last-update-time');
        if (!timeEl) {
          timeEl = document.createElement('span');
          timeEl.id = 'last-update-time';
          timeEl.style.display = 'none';
          document.body.appendChild(timeEl);
        }
        timeEl.dataset.time = now;
        setStatus('ok', `âœ… ×¢×•×“×›×Ÿ ×‘-${now} Â· ×¢×“×›×•×Ÿ ×‘×¢×•×“ 2:00`);
        startCountdown();
        render();
        btn.classList.remove('spinning');
        return;
      }
    } catch(e) { continue; }
  }

  setStatus('error', 'âŒ ×©×’×™××” ×‘×˜×¢×™× ×” - ×‘×“×•×§ ×—×™×‘×•×¨ ××™× ×˜×¨× ×˜');
  btn.classList.remove('spinning');
}

function setSort(type) {
  currentSort = type;
  document.querySelectorAll('.sort-btn').forEach(b => {
    b.classList.remove('active','green','red');
  });
  const btn = document.getElementById('sort-' + type);
  btn.classList.add('active');
  if (type === 'gainers') btn.classList.add('green');
  if (type === 'losers')  btn.classList.add('red');
  render();
}

function setSector(sector) {
  currentSector = sector;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.filter-btn').forEach(b => {
    if (b.dataset.sector === sector) b.classList.add('active');
  });
  render();
}

function renderFilters() {
  const sectors = [...new Set(companies.map(c => c.sector))].sort();
  const bar = document.getElementById('filter-bar');
  bar.innerHTML = '<span>×¡×™× ×•×Ÿ ×œ×¤×™ ×¢× ×£:</span>';

  const allBtn = document.createElement('button');
  allBtn.className = 'filter-btn' + (currentSector === '' ? ' active' : '');
  allBtn.dataset.sector = '';
  allBtn.textContent = `×”×›×œ (${companies.length})`;
  allBtn.onclick = () => setSector('');
  bar.appendChild(allBtn);

  sectors.forEach(s => {
    const count = companies.filter(c => c.sector === s).length;
    const btn = document.createElement('button');
    btn.className = 'filter-btn' + (currentSector === s ? ' active' : '');
    btn.dataset.sector = s;
    btn.textContent = `${s} (${count})`;
    btn.onclick = () => setSector(s);
    bar.appendChild(btn);
  });
}

function getFiltered() {
  const q = document.getElementById('search-input').value.trim().toLowerCase();
  let list = companies.filter(c => {
    const matchSearch = !q || c.name.includes(q) || c.id.toLowerCase().includes(q) || c.sector.includes(q);
    const matchSector = !currentSector || c.sector === currentSector;
    return matchSearch && matchSector;
  });
  if (currentSort === 'gainers')   list = [...list].sort((a,b) => b.changePercent - a.changePercent);
  if (currentSort === 'losers')    list = [...list].sort((a,b) => a.changePercent - b.changePercent);
  if (currentSort === 'marketcap') list = [...list].sort((a,b) => b.marketCap - a.marketCap);
  if (currentSort === 'volume')    list = [...list].sort((a,b) => b.volume - a.volume);
  return list;
}

function render() {
  renderFilters();
  const filtered = getFiltered();

  // update stats
  document.getElementById('stat-up').textContent   = companies.filter(c => c.changePercent > 0).length;
  document.getElementById('stat-down').textContent = companies.filter(c => c.changePercent < 0).length;

  document.getElementById('results-count').textContent =
    filtered.length === companies.length
      ? `××¦×™×’ ${filtered.length} ×—×‘×¨×•×ª`
      : `× ××¦××• ${filtered.length} ×ª×•×¦××•×ª`;

  const grid = document.getElementById('cards-grid');

  if (filtered.length === 0) {
    grid.innerHTML = `
      <div class="empty" style="grid-column:1/-1">
        <div class="empty-icon">ğŸ”</div>
        <h3>×œ× × ××¦××• ×ª×•×¦××•×ª</h3>
        <p>× ×¡×” ×œ×—×¤×© ××©×”×• ××—×¨ ××• ×œ×©× ×•×ª ××ª ×”×¡×™× ×•×Ÿ</p>
      </div>`;
    return;
  }

  grid.innerHTML = filtered.map(c => {
    const up = c.changePercent >= 0;
    const arrow = up ? 'â–²' : 'â–¼';
    const cls = up ? 'up' : 'down';
    const sign = up ? '+' : '';
    return `
      <div class="card" onclick="openModal('${c.id}')">
        <div class="card-top">
          <div class="card-name">
            <span class="card-badge">${c.id}</span>
            <div class="card-hname">${c.name}</div>
          </div>
          <div class="card-price-wrap">
            <div class="card-price">â‚ª${c.price.toFixed(2)}</div>
            <div class="card-change ${cls}">${arrow} ${sign}${c.change.toFixed(2)} (${sign}${c.changePercent.toFixed(2)}%)</div>
          </div>
        </div>
        <span class="card-sector">${c.sector}</span>
        <div class="card-stats">
          <div>
            <div class="card-stat-label">×©×•×•×™ ×©×•×§</div>
            <div class="card-stat-value">â‚ª${c.marketCap}B</div>
          </div>
          <div>
            <div class="card-stat-label">× ×¤×— 24H</div>
            <div class="card-stat-value">${formatVolume(c.volume)}</div>
          </div>
        </div>
      </div>`;
  }).join('');
}

async function openModal(id) {
  const c = companies.find(x => x.id === id);
  if (!c) return;
  const up = c.changePercent >= 0;
  const sign = up ? '+' : '';
  const cls = up ? 'up' : 'down';
  
  // ×¤×ª×— modal ×¢× ××¡×š ×˜×¢×™× ×”
  document.getElementById('modal-box').innerHTML = `
    <div class="modal-header">
      <div class="modal-header-top">
        <div>
          <span class="modal-badge">${c.id}</span>
          <div class="modal-title">${c.name}</div>
          <div class="modal-subtitle">××“×“ ×ª"× 35</div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="display:flex;align-items:baseline;gap:12px;margin-top:8px">
        <span class="modal-price">â‚ª${c.price.toFixed(2)}</span>
        <span class="modal-change ${cls}">${sign}${c.change.toFixed(2)} (${sign}${c.changePercent.toFixed(2)}%)</span>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#0f172a">ğŸ“ˆ ×‘×™×¦×•×¢×™× ×”×™×¡×˜×•×¨×™×™×</h3>
        </div>
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:60px 40px;text-align:center;box-shadow:0 4px 16px rgba(0,0,0,0.04)">
          <div style="width:48px;height:48px;margin:0 auto 20px;border:3px solid #e2e8f0;border-top-color:#3b82f6;border-radius:50%;animation:spin 0.8s linear infinite"></div>
          <div style="font-size:15px;font-weight:600;color:#64748b;margin-bottom:6px">××•×©×š × ×ª×•× ×™× ××”×‘×•×¨×¡×”</div>
          <div style="font-size:13px;color:#94a3b8">×™×™×§×— ××¡×¤×¨ ×©× ×™×•×ª...</div>
        </div>
      </div>
    </div>`;
  document.getElementById('modal-overlay').classList.add('open');
  
  // ××©×•×š × ×ª×•× ×™× ×”×™×¡×˜×•×¨×™×™× (async)
  const trendData = await generateTrendData(c);
  const isRealData = trendData && trendData.length >= 20; // ×× ×™×© ××¡×¤×™×§ × ×ª×•× ×™× ×××™×ª×™×™×
  const chart = renderProfessionalChart(trendData, c, isRealData);
  
  // ×¢×“×›×Ÿ ××ª ×”-modal ×¢× ×”×’×¨×£
  document.getElementById('modal-box').innerHTML = `
    <div class="modal-header">
      <div class="modal-header-top">
        <div>
          <span class="modal-badge">${c.id}</span>
          <div class="modal-title">${c.name}</div>
          <div class="modal-subtitle">××“×“ ×ª"× 35</div>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div style="display:flex;align-items:baseline;gap:12px;margin-top:8px">
        <span class="modal-price">â‚ª${c.price.toFixed(2)}</span>
        <span class="modal-change ${cls}">${sign}${c.change.toFixed(2)} (${sign}${c.changePercent.toFixed(2)}%)</span>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
          <h3 style="margin:0;font-size:18px;font-weight:700;color:#0f172a">ğŸ“ˆ ×‘×™×¦×•×¢×™× ×”×™×¡×˜×•×¨×™×™×</h3>
          <span style="font-size:12px;color:#64748b;font-weight:500">${trendData.length} ×™××™ ××¡×—×¨</span>
        </div>
        <div style="background:white;border:1px solid #e2e8f0;border-radius:16px;padding:24px;box-shadow:0 4px 16px rgba(0,0,0,0.04)">
          ${chart}
        </div>
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-top:16px;padding:12px;background:#f8fafc;border-radius:8px;border:1px solid #e2e8f0">
          ${isRealData 
            ? '<span style="font-size:13px;color:#10b981;font-weight:600">âœ“ ××‘×•×¡×¡ ×¢×œ × ×ª×•× ×™ ×‘×•×¨×¡×ª ×ª×œ ××‘×™×‘</span>' 
            : '<span style="font-size:13px;color:#f59e0b;font-weight:600">âš  ×”×“××™×” ××‘×•×¡×¡×ª ××’××” (× ×ª×•× ×™× ×××™×ª×™×™× ×œ× ×–××™× ×™×)</span>'}
        </div>
      </div>
      <div class="modal-section">
        <h3>ğŸ“‹ ×ª×™××•×¨ ×”×—×‘×¨×”</h3>
        <p class="modal-desc">×—×‘×¨×” ×¦×™×‘×•×¨×™×ª ×”× ×¡×—×¨×ª ×‘×‘×•×¨×¡×ª ×ª×œ ××‘×™×‘ ×‘××¡×’×¨×ª ××“×“ ×ª"× 35.</p>
        <span class="modal-sector-tag">${c.sector}</span>
      </div>
      <div class="modal-section">
        <h3>ğŸ“Š × ×ª×•× ×™× ×¢×™×§×¨×™×™×</h3>
        <div class="modal-stats-grid">
          <div class="modal-stat">
            <div class="modal-stat-label">×©×•×•×™ ×©×•×§</div>
            <div class="modal-stat-value">â‚ª${c.marketCap}B</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">× ×¤×— 24H</div>
            <div class="modal-stat-value">${formatVolume(c.volume)}</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">×©×™× ×©× ×ª×™ (××•××“×Ÿ)</div>
            <div class="modal-stat-value green">â‚ª${c.yearHigh.toFixed(2)}</div>
          </div>
          <div class="modal-stat">
            <div class="modal-stat-label">×©×¤×œ ×©× ×ª×™ (××•××“×Ÿ)</div>
            <div class="modal-stat-value red">â‚ª${c.yearLow.toFixed(2)}</div>
          </div>
        </div>
      </div>
      <div class="modal-section">
        <h3>ğŸ”— ×§×™×©×•×¨×™× ×•××©××‘×™×</h3>
        <div class="modal-links">
          <a href="${c.website}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸŒ</span> ××ª×¨ ×”×—×‘×¨×”
          </a>
          <a href="https://www.tase.co.il/he/market_data/security/${c.id}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸ“ˆ</span> × ×ª×•× ×™× ×‘×‘×•×¨×¡×” ×œ× ×™×™×¨×•×ª ×¢×¨×š
          </a>
          <a href="https://maya.tase.co.il/company/${c.id}" target="_blank" rel="noopener" class="modal-link">
            <span class="modal-link-icon">ğŸ“„</span> ×“×•×—×•×ª ×›×¡×¤×™×™× ×‘×××™×”
          </a>
        </div>
      </div>
      <div class="modal-note">
        <strong>×©×™× ×œ×‘:</strong> ×”× ×ª×•× ×™× ××ª×¢×“×›× ×™× ××”-Google Sheets ×©×œ×š ×›×œ 2 ×“×§×•×ª. ×œ× ×ª×•× ×™× ××“×•×™×§×™× ×‘×–××Ÿ ×××ª, ×¢×‘×•×¨ ×œ××ª×¨ ×”×‘×•×¨×¡×”.
      </div>
    </div>`;
}

function closeModal(e) {
  if (!e || e.target === document.getElementById('modal-overlay')) {
    document.getElementById('modal-overlay').classList.remove('open');
  }
}

document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

// ×˜×¢×™× ×” ×¨××©×•× ×™×ª + ×¨×™×¢× ×•×Ÿ ××•×˜×•××˜×™
fetchData();
setInterval(fetchData, REFRESH_INTERVAL);
</script>
</body>
</html>
